<section class="cuidador-page">
  <header class="cuidador-page__header">
    <h1><%= title || 'Cuidadores' %></h1>
    <p class="subtitle">Cuidadores associados às suas crianças.</p>

    <div class="toolbar">
      <input id="busca" type="search" placeholder="Buscar por nome…" aria-label="Buscar cuidador" />
      <button id="reload" class="btn btn--ghost" type="button" title="Recarregar">
        <i class="fa fa-rotate-right"></i>
      </button>
    </div>
  </header>

  <div id="status" class="status" role="status" aria-live="polite">Carregando cuidadores…</div>
  <div id="grid" class="cuidador-grid" hidden></div>
  <div id="empty" class="empty" hidden>Nenhum cuidador encontrado.</div>
</section>

<style>
  .cuidador-page { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
  .cuidador-page__header { display: grid; gap: .5rem; margin-bottom: 1rem; }
  .subtitle { color: #666; }
  .toolbar { display: flex; gap: .5rem; align-items: center; }
  .toolbar input[type="search"] { flex: 1; padding: .6rem .8rem; border: 1px solid #ddd; border-radius: .6rem; }
  .btn { padding: .55rem .9rem; border-radius: .6rem; border: 1px solid #ddd; cursor: pointer; }
  .btn--ghost { background: #fafafa; }
  .status { margin: 1rem 0; color: #666; }
  .empty { margin-top: 1rem; color: #777; text-align: center; }

  .cuidador-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; }
  .cuidador-card {
    display: grid; grid-template-rows: auto 1fr auto; gap: .6rem; padding: 1rem;
    border: 1px solid #eee; border-radius: 1rem; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,.04);
  }
  .cuidador-card__header { display: flex; gap: .8rem; align-items: center; }
  .avatar { width: 48px; height: 48px; border-radius: 50%; background: #f2f2f2; display: grid; place-items: center; overflow: hidden; }
  .avatar img { width: 100%; height: 100%; object-fit: cover; }
  .avatar__initials { font-weight: 700; color: #666; }
  .name { font-size: 1.05rem; font-weight: 700; }
  .muted { color: #777; font-size: .92rem; }
  .cuidador-card__footer { display: flex; gap: .5rem; justify-content: flex-end; }
  .btn--primary { background: #3b82f6; color: #fff; border-color: transparent; }
</style>

<script>
(function () {
  const grid = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const emptyEl = document.getElementById('empty');
  const busca = document.getElementById('busca');
  const reload = document.getElementById('reload');

  let data = [];

  function authFetch(url, options = {}) {
    const token = localStorage.getItem('token');
    const headers = Object.assign({}, options.headers || {}, token ? { Authorization: 'Bearer ' + token } : {});
    return fetch(url, { ...options, headers, credentials: 'same-origin' });
  }

  function setLoading(isLoading, msg = 'Carregando cuidadores…') {
    statusEl.textContent = isLoading ? msg : '';
    statusEl.hidden = !isLoading;
    grid.hidden = true;
    emptyEl.hidden = true;
  }

  function avatarNode(nome, fotoUrl) {
    const wrapper = document.createElement('div');
    wrapper.className = 'avatar';
    if (fotoUrl) {
      const img = document.createElement('img');
      img.src = fotoUrl;
      img.alt = nome ? `Foto de ${nome}` : 'Foto do cuidador';
      wrapper.appendChild(img);
    } else {
      const span = document.createElement('span');
      span.className = 'avatar__initials';
      span.textContent = (nome || '?').split(/\s+/).map(p => p[0]?.toUpperCase() || '').slice(0, 2).join('');
      wrapper.appendChild(span);
    }
    return wrapper;
  }

  function render(list) {
    grid.innerHTML = '';
    if (!list.length) {
      grid.hidden = true;
      emptyEl.hidden = false;
      return;
    }
    list.forEach(c => {
      const card = document.createElement('article');
      card.className = 'cuidador-card';

      const header = document.createElement('div');
      header.className = 'cuidador-card__header';

      const info = document.createElement('div');
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = c.nome || 'Sem nome';

      const muted = document.createElement('div');
      muted.className = 'muted';
      muted.textContent = c.email || c.telefone || 'Sem contato';

      info.appendChild(name);
      info.appendChild(muted);

      header.appendChild(avatarNode(c.nome, c.fotoUrl));
      header.appendChild(info);

      const footer = document.createElement('div');
      footer.className = 'cuidador-card__footer';
      const btn = document.createElement('button');
      btn.className = 'btn btn--primary';
      btn.textContent = 'Ver perfil';
      btn.addEventListener('click', () => {
        window.location.href = `/cuidadores/${encodeURIComponent(c.id)}`;

      });
      footer.appendChild(btn);

      card.appendChild(header);
      card.appendChild(document.createElement('div')); // espaço flex
      card.appendChild(footer);

      grid.appendChild(card);
    });

    emptyEl.hidden = true;
    grid.hidden = false;
  }

  function filtrar(term) {
    const t = (term || '').trim().toLowerCase();
    if (!t) return data;
    return data.filter(c =>
      (c.nome || '').toLowerCase().includes(t) ||
      (c.email || '').toLowerCase().includes(t) ||
      (c.telefone || '').toLowerCase().includes(t)
    );
  }

  async function carregar() {
    setLoading(true);
    try {
      const res = await authFetch('/api/cuidadores');
      if (res.status === 401) {
        statusEl.textContent = 'Você precisa entrar para ver os cuidadores.';
        return;
      }
      if (!res.ok) throw new Error('Falha ao buscar cuidadores');
      data = await res.json();
      render(filtrar(busca.value));
      statusEl.hidden = true;
    } catch (e) {
      console.error(e);
      setLoading(true, 'Erro ao carregar. Tente novamente.');
    }
  }

  // eventos
  let debounce;
  busca.addEventListener('input', () => {
    clearTimeout(debounce);
    debounce = setTimeout(() => render(filtrar(busca.value)), 150);
  });

  reload.addEventListener('click', carregar);

  // init
  carregar();
})();
</script>
